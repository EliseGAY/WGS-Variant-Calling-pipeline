#!/usr/bin/bash
#==================#
# Load Directories
#==================#
# file with list of contig/chr/scaffold to map in one column
Intervall_list="/travail/egay/Whole_Genome_analysis_GWS/GATK/GATK_15samples/interval.list"

while read chr;
do
        cat > Filter_SFS_Str_${chr}.sh << EOF
#!/bin/sh
#SBATCH --clusters=mesopsl1
#SBATCH --account=gay
#SBATCH --partition=def
#SBATCH --qos=mesopsl1_def_long
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=10
#SBATCH --job-name=Filtre${chr}
#SBATCH --time=24:00:00
#SBATCH -o Filter_${chr}.o
#SBATCH -e Filter_${chr}.e

# IMPORT MODULE
module load gcc/9.2.0
module load samtools/1.10
module load gatk/4.2.0.0

#------------------------------------------------------------#
# Discard LowQual position : Repeat / MQFilter / LowQual
# Discard Indels
#------------------------------------------------------------#
# get header :
bcftools view ${chr}_GATK_TAG.vcf.gz | head -n760 >  ${chr}_GATK_TAG.header

# filter low qual and indel
bcftools view -H ${chr}_GATK_TAG.vcf.gz | grep -v "MQFILTER\|LowQual\|Repeat" |  awk '!(\$5 ~ "^*")' | awk '!(\$5 ~ "^[ACGT*].")' | awk '!(\$4 ~ "^[ACGT*].")' >> ${chr}_GATK_TAG_Flowqual_Noindels_Temp.vcf

# add header
cat SUPER_21_GATK_TAG.header ${chr}_GATK_TAG_Flowqual_Noindels_Temp.vcf >> ${chr}_GATK_TAG_Flowqual_Noindels.vcf

# zip vcf
bcftools view ${chr}_GATK_TAG_Flowqual_Noindels.vcf -o ${chr}_GATK_TAG_Flowqual_Noindels.vcf.gz -Oz

# index vcf
bcftools index ${chr}_GATK_TAG_Flowqual_Noindels.vcf.gz

# remove temp file
rm ${chr}_GATK_TAG_Flowqual_Noindels_Temp.vcf ${chr}_GATK_TAG_Flowqual_Noindels.vcf

#------------------------------------------------------------#
# Genetic Diversity
#------------------------------------------------------------#

# Discard all missing data
bcftools view ${chr}_GATK_TAG_Flowqual_Noindels.vcf.gz | vcftools --vcf '-' --max-missing 1 --stdout --recode | bcftools view -o ${chr}_GATK_TAG_Flowqual_Noindels_NoNa.vcf.gz -Oz
bcftools index ${chr}_GATK_TAG_Flowqual_Noindels_NoNa.vcf.gz

# VCF use to extract position in order to normalize diversity by total number of called position (include ref position).
bcftools view ${chr}_GATK_TAG_Flowqual_Noindels_NoNa.vcf.gz | cut -f2 >> ${chr}_total_position.txt

# No REF
bcftools view -v snps ${chr}_GATK_TAG_Flowqual_Noindels_NoNa.vcf.gz -o ${chr}_GATK_TAG_Flowqual_Noindels_NoNa_SNP.vcf.gz -Oz

# index
bcftools index ${chr}_GATK_TAG_Flowqual_Noindels_NoNa_SNP.vcf.gz

# then filter number of genotype "0/1"  : select freq max of "0/1" among your population
# use the R script of Stefano

#------------------------------------------------------------#
# FST / PCA
#------------------------------------------------------------#
# discard reference homozygous site and Missing data
# Example with VCFTOOLS
# 0=100% missing data allowed per site (SFS analysis)
# 0.2=80% missing data allowed per site (usually in structure analyse)
# 1= 0% missing data allowed,

# Get only SNP, Allow max 20% missing data per position
bcftools view -v snps ${chr}_GATK_TAG_Flowqual_Noindels.vcf.gz | vcftools --vcf '-' --max-missing 0.8 --stdout --recode | bcftools view -o Str_${chr}_GATK_TAG_Flowqual_Noindels_NoRef_Na20.vcf.ga -Oz

# index
bcftools index Str_${chr}_GATK_TAG_Flowqual_Noindels_NoRef_Na20.vcf.gz

# MAF : either with Bash or R
# option -i = include -e : exclude
# bcftools view -i "MAF>0.05" {VCF_Output}_Noindels_Nolowqual_NoREF_Missin02.vcf -o {VCF_Output}_Noindels_Nolowqual_NoREF_Missin02_MAF005.vcf -Oz

# NO Filter number of genotype "0/1"

EOF
sbatch Filter_SFS_Str_${chr}.sh
done < ${Intervall_list}
